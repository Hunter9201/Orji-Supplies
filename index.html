<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Orji Supplies – Laundry & Home Cleaning (Cash on Delivery)</title>
  <meta name="description" content="Orji Supplies: Premium laundry & home-cleaning products in Kampala. Retail & wholesale. Cash on Delivery. Fast same-day delivery." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{--brand:#0ea5e9;--brand-d:#0284c7;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--bg:#f8fafc;--wa:#25D366;--rose:#fb7185;--card:#fff}
    *{box-sizing:border-box} html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--ink)}

    .topbar{background:linear-gradient(90deg,var(--brand),#22c55e);color:#fff;padding:6px 14px;font-weight:700;display:flex;gap:12px;justify-content:center;align-items:center;font-size:14px}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:50;backdrop-filter:saturate(190%) blur(6px)}
    .nav{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;max-width:1200px;margin:0 auto}
    .brand{font-weight:800;font-size:20px;display:flex;align-items:center;gap:10px}
    .brand .logo{width:36px;height:36px;background:var(--brand);color:#fff;border-radius:8px;display:grid;place-items:center;box-shadow:0 6px 14px rgba(14,165,233,.25)}
    .nav-actions{display:flex;gap:8px;align-items:center}
    .button{padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:800;border:1px solid var(--line);cursor:pointer;background:#fff;color:var(--ink)}
    .button:hover{filter:brightness(.98)}
    .primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .primary:hover{background:var(--brand-d)}

    /* Hero (with carousel) */
    .hero-wrap{background:conic-gradient(from 180deg at 50% 50%, #e0f2fe 0deg, #dcfce7 180deg, #e0f2fe 360deg)}
    .hero{display:grid;grid-template-columns:1.05fr .95fr;gap:24px;align-items:center;padding:28px 16px;max-width:1200px;margin:0 auto}
    .hero h1{font-size:clamp(28px,3.6vw,44px);margin:0 0 8px}
    .hero p{color:var(--muted);margin:0 0 14px}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .badge{background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}

    .hero-gallery{position:relative;width:100%;aspect-ratio:16/9;border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(2,6,23,.18);background:#eef2f7}
    .hslide{position:absolute;inset:0;opacity:0;transition:opacity .45s ease}
    .hslide.active{opacity:1}
    .hslide img{width:100%;height:100%;object-fit:cover}
    .hg-arrows{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
    .hg-arrows button{pointer-events:auto;border:0;background:rgba(0,0,0,.35);color:#fff;width:36px;height:36px;border-radius:50%;display:grid;place-items:center;cursor:pointer}
    .hg-dots{position:absolute;left:0;right:0;bottom:8px;display:flex;justify-content:center;gap:6px}
    .hg-dots .dot{width:8px;height:8px;border-radius:50%;background:rgba(15,23,42,.35);box-shadow:0 0 0 1px rgba(255,255,255,.6) inset}
    .hg-dots .dot.active{background:#fff}

    .controls{position:sticky;top:68px;background:#ffffffd9;backdrop-filter:blur(6px);border-block:1px solid var(--line)}
    .controls-inner{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 16px;max-width:1200px;margin:0 auto}
    .muted{color:var(--muted);font-size:12px}
    .search{display:flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .search input{border:0;outline:none;min-width:150px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700;font-size:12px}
    .chip[aria-pressed="true"]{background:var(--ink);color:#fff}
    .select{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:700}
    .mode-tabs{position:relative;display:inline-flex;align-items:center;gap:6px;background:#0f172a0d;border:1px solid #cbd5e1;padding:6px;border-radius:999px}
    .mode-tabs .thumb{position:absolute;top:6px;bottom:6px;width:50%;border-radius:999px;background:var(--brand);z-index:0;transition:transform .25s ease,background-color .25s ease}
    [data-mode="retail"] .mode-tabs .thumb{transform:translateX(0)}
    [data-mode="wholesale"] .mode-tabs .thumb{transform:translateX(100%);background:#16a34a}
    .mode-tabs button{position:relative;z-index:1;border:0;background:transparent;padding:10px 18px;border-radius:999px;font-weight:800;font-size:15px;color:var(--ink);cursor:pointer}
    .mode-tabs button[aria-pressed="true"]{color:#fff}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:16px;padding:18px 16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;display:flex;flex-direction:column;overflow:hidden;transition:transform .18s,box-shadow .18s}
    .card:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(2,6,23,.12)}
    .card .tag{position:absolute;top:10px;left:10px;background:#ffffffea;border:1px solid var(--line);font-weight:800;font-size:11px;border-radius:999px;padding:4px 8px;z-index:5}
    .card .rating{position:absolute;top:10px;right:10px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;z-index:5}
    .card .body{padding:12px}
    .card h3{margin:0 0 6px;font-size:16px}
    .price{font-weight:800;margin:6px 0}
    .moq{display:inline-block;font-size:11px;background:#d1fae5;color:#065f46;border:1px solid #a7f3d0;border-radius:999px;padding:2px 8px;margin-left:6px}
    .qty{margin:8px 0;display:flex;align-items:center;gap:8px}
    .qty input{width:96px;padding:8px 10px;border-radius:10px;border:1px solid var(--line)}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .buyNow{background:#10b981;color:#fff;border-color:#10b981}

    /* Product gallery (1–4 per item) */
    .gallery{display:flex;flex-direction:column;background:#f1f5f9}
    .gallery-main{position:relative;width:100%;aspect-ratio:4/3;overflow:hidden;border-bottom:1px solid var(--line)}
    .gslide{position:absolute;inset:0;opacity:0;transition:opacity .35s ease}
    .gslide.active{opacity:1}
    .gslide img{width:100%;height:100%;object-fit:cover;background:#eef2f7}
    .garrows{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
    .garrows button{pointer-events:auto;border:0;background:rgba(0,0,0,.35);color:#fff;width:34px;height:34px;border-radius:50%;display:grid;place-items:center;cursor:pointer}
    .gdots{position:absolute;left:0;right:0;bottom:6px;display:flex;justify-content:center;gap:6px;pointer-events:none}
    .gdots .dot{width:7px;height:7px;border-radius:50%;background:rgba(15,23,42,.35);box-shadow:0 0 0 1px rgba(255,255,255,.5) inset}
    .gdots .dot.active{background:#fff}
    .gthumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;padding:8px}
    .gthumb{position:relative;width:100%;aspect-ratio:1/1;border:2px solid transparent;border-radius:8px;overflow:hidden;cursor:pointer;background:#eef2f7}
    .gthumb.active{border-color:var(--brand)}
    .gthumb img{width:100%;height:100%;object-fit:cover}

    .drawer{position:fixed;top:0;right:-420px;width:380px;max-width:92vw;height:100vh;background:#fff;border-left:1px solid var(--line);transition:right .22s;z-index:100;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer header{padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .drawer main{flex:1;overflow:auto;padding:12px}
    .drawer footer{padding:12px;border-top:1px solid var(--line)}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.5);z-index:120}
    .modal.open{display:grid}
    .sheet{width:min(640px,94vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 30px 60px rgba(2,6,23,.35)}
    .sheet header,.sheet footer{padding:12px 16px;border-bottom:1px solid var(--line)}
    .sheet footer{border-top:1px solid var(--line);border-bottom:0;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .sheet main{padding:12px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select,.field textarea{padding:10px 12px;border:1px solid var(--line);border-radius:10px}

    .fab{position:fixed;right:16px;bottom:16px;display:none;align-items:center;gap:8px;padding:12px 16px;border-radius:999px;background:var(--wa);color:#fff;font-weight:800;text-decoration:none;box-shadow:0 10px 20px rgba(2,6,23,.18);z-index:120}
    .fab:hover{filter:brightness(.96)}
    .trust{max-width:1200px;margin:8px auto 20px;padding:0 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .tcard{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;align-items:start;gap:10px}
    footer.site{margin-top:20px;border-top:1px solid var(--line);padding:18px 16px;background:#fff}

    @media (max-width:940px){.hero{grid-template-columns:1fr}.controls{top:60px}}
    @media (max-width:480px){.search input{min-width:120px}}
  </style>
</head>
<body data-mode="retail">
  <div class="topbar" role="status" aria-live="polite">
    <span>Pay on Delivery • Same-day Kampala delivery (before 4pm)</span>
  </div>

  <header>
    <div class="nav">
      <div class="brand"><div class="logo">O</div> Orji Supplies</div>
      <div class="nav-actions">
        <a class="button" id="callBtn">Call to Order</a>
        <a href="#catalog" class="button primary">Browse Products</a>
        <button id="cartBtn" class="button">Cart <span id="cartCount" style="background:var(--rose);color:#fff;border-radius:50%;padding:2px 6px;font-size:12px;display:none;">0</span></button>
      </div>
    </div>
  </header>

  <!-- HERO with auto-loading images -->
  <div class="hero-wrap">
    <section class="hero">
      <div>
        <h1>Premium Laundry & Home Cleaning Products</h1>
        <p>Retail & Wholesale • Kampala & Surrounds • Cash on Delivery.</p>
        <div class="badges">
          <span class="badge">Trusted by 500+ homes</span>
          <span class="badge">Fast Kampala delivery</span>
          <span class="badge">Bulk discounts</span>
        </div>
        <div class="stack">
          <a href="#catalog" class="button primary">Shop Now</a>
          <a class="button" id="waHello">WhatsApp Us</a>
        </div>
      </div>
      <div class="hero-gallery" id="heroGallery" aria-label="Featured images">
        <!-- slides injected by JS -->
        <div class="hg-arrows"><button id="hPrev" aria-label="Previous">‹</button><button id="hNext" aria-label="Next">›</button></div>
        <div class="hg-dots" id="hDots"></div>
      </div>
    </section>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="controls-inner">
      <div class="stack" style="align-items:center"><strong>Catalog</strong> <span class="muted">– find what you need fast</span></div>
      <div class="search" role="search"><input id="searchInput" placeholder="Search soap, insecticide, mop…" aria-label="Search products" /></div>
      <div class="chips" id="chips" role="group" aria-label="Filter by category"></div>
      <select id="sortSel" class="select" aria-label="Sort">
        <option value="pop">Popular</option><option value="priceAsc">Price: Low → High</option><option value="priceDesc">Price: High → Low</option><option value="name">Name A → Z</option>
      </select>
      <div class="mode-tabs" id="modeTabs" role="group" aria-label="Buying mode">
        <span class="thumb" aria-hidden="true"></span>
        <button type="button" data-mode="retail" aria-pressed="true">Retail</button>
        <button type="button" data-mode="wholesale" aria-pressed="false">Wholesale</button>
      </div>
    </div>
  </div>

  <!-- Product grid -->
  <section id="catalog"><div class="grid" id="grid"></div></section>

  <!-- Trust -->
  <section class="trust" aria-label="Why shop with Orji">
    <div class="tcard"><strong>Cash on Delivery</strong><div class="muted">Pay only when your items arrive.</div></div>
    <div class="tcard"><strong>Same-Day Delivery</strong><div class="muted">Order before 4pm in Kampala.</div></div>
    <div class="tcard"><strong>Top Brands</strong><div class="muted">Harpic, Vim, Pledge, more.</div></div>
    <div class="tcard"><strong>Wholesale Ready</strong><div class="muted">Easy bulk re-orders.</div></div>
  </section>

  <footer class="site">
    <div style="max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between">
      <p>© <span id="year"></span> Orji Supplies. Kampala, Uganda.</p>
      <div class="muted">Call <a href="#" id="callLink">+256 783 501 222</a> • WhatsApp <a href="#" id="waLink" target="_blank">chat</a></div>
    </div>
  </footer>

  <!-- Cart Drawer -->
  <aside id="drawer" class="drawer" aria-label="Cart drawer" aria-live="polite">
    <header><strong>Your Cart</strong><button id="closeDrawer" class="button">Close</button></header>
    <main id="cartLines"></main>
    <footer>
      <div id="grandTotal" style="font-weight:800">Total: UGX 0</div>
      <div class="muted" style="margin:6px 0">Payment: <strong>Cash on Delivery</strong></div>
      <div class="muted" style="margin:6px 0">Delivery area:
        <select id="areaSel" class="select" style="padding:6px 8px">
          <option value="Kampala Central">Kampala Central</option><option value="Wakiso">Wakiso</option><option value="Entebbe">Entebbe</option><option value="Upcountry">Upcountry</option>
        </select>
      </div>
      <div class="stack" style="margin-top:10px"><button id="openCheckout" class="button primary">Proceed to Checkout</button></div>
    </footer>
  </aside>

  <!-- Floating WhatsApp Checkout -->
  <a id="checkoutFab" class="fab" href="#" target="_blank" aria-label="Checkout on WhatsApp (COD)">
    <svg viewBox="0 0 32 32" aria-hidden="true"><path fill="currentColor" d="M19.11 17.56c-.26-.13-1.52-.75-1.76-.84s-.41-.13-.58.13-.66.84-.81 1.01-.3.19-.56.06a8.94 8.94 0 0 1-2.64-1.63 9.9 9.9 0 0 1-1.84-2.28c-.19-.32 0-.49.13-.62.13-.13.26-.32.39-.45.13-.13.19-.26.32-.45.13-.19.06-.36 0-.49-.06-.13-.58-1.39-.8-1.89-.21-.51-.43-.44-.58-.45h-.5a.96.96 0 0 0-.69.32c-.24.26-.9.88-.9 2.14s.92 2.49 1.05 2.66c.13.17 1.81 2.76 4.39 3.87.61.26 1.08.41 1.45.52.61.19 1.16.16 1.6.1.49-.07 1.52-.62 1.74-1.22.21-.58.21-1.08.15-1.22-.06-.13-.24-.2-.5-.33zM16 3C9.37 3 4 8.37 4 15c0 2.12.55 4.1 1.52 5.83L4 29l8.33-1.46A12.95 12.95 0 0 0 16 27c6.63 0 12-5.37 12-12S22.63 3 16 3zm0 22.33c-1.84 0-3.55-.54-4.98-1.46l-.36-.23-4.94.86.86-4.81-.24-.39A9.36 9.36 0 1 1 25.36 20a9.33 9.33 0 0 1-9.36 5.33z"/></svg>
    <span>Checkout</span>
  </a>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ckTitle">
    <div class="sheet">
      <header><strong id="ckTitle">Cash on Delivery – Delivery Details</strong></header>
      <main>
        <div class="row">
          <div class="field"><label for="custName">Full Name</label><input id="custName" autocomplete="name" /></div>
          <div class="field"><label for="custPhone">Phone (for rider)</label><input id="custPhone" inputmode="tel" autocomplete="tel" /></div>
        </div>
        <div class="row">
          <div class="field"><label for="custArea">Delivery Area</label>
            <select id="custArea"><option>Kampala Central</option><option>Wakiso</option><option>Entebbe</option><option>Upcountry</option></select>
          </div>
          <div class="field"><label for="custTime">Preferred Time</label>
            <select id="custTime"><option>Anytime Today</option><option>Morning (8am–12pm)</option><option>Afternoon (12–4pm)</option><option>Evening (4–8pm)</option></select>
          </div>
        </div>
        <div class="field"><label for="custAddr">Exact Address / Landmarks</label><textarea id="custAddr" rows="3"></textarea></div>
        <div class="field"><label for="custNote">Order Note (optional)</label><input id="custNote" /></div>
        <div class="muted">Payment Method: <strong>Cash on Delivery</strong>.</div>
      </main>
      <footer>
        <button id="closeModal" class="button">Cancel</button>
        <a id="placeOrderBtn" class="button primary" target="_blank">Place Order on WhatsApp</a>
      </footer>
    </div>
  </div>

  <script>
    // ========= SETTINGS (your Admin repo) =========
    const ADMIN_BASE = 'https://hunter9201.github.io/Admin.Html-Orjisupplies/';
    const PRODUCTS_URL = ADMIN_BASE + 'products.json';
    // WhatsApp/Call number (0783501222 -> +256783501222)
    const WHATSAPP_NUMBER = '256783501222';
    const CALL_NUMBER = '+256783501222';

    // --------- Common elements/links ----------
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('callBtn').href  = `tel:${CALL_NUMBER}`;
    document.getElementById('callLink').href = `tel:${CALL_NUMBER}`;
    document.getElementById('waHello').href  = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent('Hi Orji Supplies, I want to place an order (Cash on Delivery).')}`;
    document.getElementById('waLink').href   = `https://wa.me/${WHATSAPP_NUMBER}`;

    // ========= HERO IMAGES =========
    const heroEl = document.getElementById('heroGallery');
    const hDots  = document.getElementById('hDots');
    const hPrev  = document.getElementById('hPrev');
    const hNext  = document.getElementById('hNext');
    let HERO = []; let hIndex = 0; let hTimer = null; const HERO_MS = 3500;

    function absFromAdmin(path){
      if (!path) return '';
      if (/^https?:\/\//i.test(path)) return path; // absolute allowed
      return ADMIN_BASE + path.replace(/^\/+/, '');
    }

    async function probe(url){
      try { const r = await fetch(url, { method:'HEAD' }); return r.ok; } catch { return false; }
    }

    async function loadHero(){
      // Try hero.json first
      try{
        const res = await fetch(ADMIN_BASE + 'hero.json', { cache:'no-store' });
        if (res.ok) {
          const arr = await res.json();
          if (Array.isArray(arr)) HERO = arr.map(absFromAdmin).filter(Boolean);
        }
      }catch{}
      // If no hero.json, probe common filenames in root and /images
      if (!HERO.length){
        const candidates = [
          'hero.jpg','hero1.jpg','hero2.jpg','hero3.jpg','hero4.jpg',
          'images/hero.jpg','images/hero1.jpg','images/hero2.jpg','images/hero3.jpg','images/hero4.jpg'
        ].map(absFromAdmin);
        for (const u of candidates){
          /* eslint no-await-in-loop: 0 */
          if (await probe(u)) HERO.push(u);
        }
      }
      // If still nothing, stop.
      if (!HERO.length){
        heroEl.style.display = 'none';
        return;
      }
      renderHero();
      startHero();
      heroEl.addEventListener('mouseenter', stopHero, {passive:true});
      heroEl.addEventListener('mouseleave', startHero, {passive:true});
      hPrev.addEventListener('click', ()=>{ stopHero(); showHero(hIndex-1); startHero(); });
      hNext.addEventListener('click', ()=>{ stopHero(); showHero(hIndex+1); startHero(); });
    }

    function renderHero(){
      heroEl.querySelectorAll('.hslide').forEach(n=>n.remove());
      hDots.innerHTML = '';
      HERO.forEach((src,i)=>{
        const s = document.createElement('div'); s.className = 'hslide' + (i===0?' active':'');
        s.innerHTML = `<img src="${src}" alt="Featured ${i+1}" loading="${i===0?'eager':'lazy'}" onerror="this.style.display='none'">`;
        heroEl.appendChild(s);
        const d = document.createElement('span'); d.className = 'dot' + (i===0?' active':''); d.dataset.i=i;
        d.addEventListener('click', ()=>{ stopHero(); showHero(i); startHero(); });
        hDots.appendChild(d);
      });
    }
    function showHero(n){
      const slides = heroEl.querySelectorAll('.hslide');
      const dots   = hDots.querySelectorAll('.dot');
      if (!slides.length) return;
      hIndex = ( (n%slides.length) + slides.length ) % slides.length;
      slides.forEach((s,i)=> s.classList.toggle('active', i===hIndex));
      dots.forEach((d,i)=> d.classList.toggle('active', i===hIndex));
    }
    function startHero(){ if (!hTimer && HERO.length>1) hTimer = setInterval(()=>showHero(hIndex+1), HERO_MS); }
    function stopHero(){ if (hTimer){ clearInterval(hTimer); hTimer = null; } }

    // ========= CATALOG =========
    const grid=document.getElementById('grid');
    const cartBtn=document.getElementById('cartBtn');
    const drawer=document.getElementById('drawer');
    const closeDrawer=document.getElementById('closeDrawer');
    const cartLines=document.getElementById('cartLines');
    const grandTotal=document.getElementById('grandTotal');
    const checkoutFab=document.getElementById('checkoutFab');
    const cartCount=document.getElementById('cartCount');
    const areaSel=document.getElementById('areaSel');
    const modeTabs=document.getElementById('modeTabs');
    const searchInput=document.getElementById('searchInput');
    const chips=document.getElementById('chips');
    const sortSel=document.getElementById('sortSel');
    const openCheckout=document.getElementById('openCheckout');
    const checkoutModal=document.getElementById('checkoutModal');
    const closeModal=document.getElementById('closeModal');
    const placeOrderBtn=document.getElementById('placeOrderBtn');
    const custName=document.getElementById('custName');
    const custPhone=document.getElementById('custPhone');
    const custArea=document.getElementById('custArea');
    const custTime=document.getElementById('custTime');
    const custAddr=document.getElementById('custAddr');
    const custNote=document.getElementById('custNote');

    let PRODUCTS = []; // fetched
    const CATEGORIES = [
      {id:'all',label:'All'},
      {id:'laundry',label:'Laundry'},
      {id:'home',label:'Home Care'},
      {id:'accessories',label:'Accessories'},
      {id:'pest',label:'Pest Control'}
    ];
    let mode='retail';
    let cart=new Map();
    let activeCat='all';

    const fmtUGX=v=>new Intl.NumberFormat('en-UG',{style:'currency',currency:'UGX',maximumFractionDigits:0}).format(v);
    const priceOf=p=>mode==='retail'?p.retailPrice:p.wholesalePrice;
    const minQty=p=>mode==='retail'?1:(p.moq||1);
    function estDeliveryFee(area,subtotal){
      if(area.includes('Kampala')) return subtotal>=100000?0:5000;
      if(area.includes('Wakiso')) return 8000;
      if(area.includes('Entebbe')) return 10000;
      return 15000;
    }

    function normalizeImgs(p){
      // Supports p.imgs (array) or p.img (single). Accepts absolute URLs (anywhere) or relative (resolved under ADMIN_BASE)
      let arr = Array.isArray(p.imgs) && p.imgs.length ? p.imgs : (p.img?[p.img]:[]);
      arr = arr.map(u => (/^https?:\/\//i.test(u) ? u : ADMIN_BASE + u.replace(/^\/+/,'') )).filter(Boolean);
      if(!arr.length) arr=['']; // placeholder path -> will show fallback
      return arr.slice(0,4);
    }

    function renderChips(){
      chips.innerHTML = CATEGORIES.map(c => `<button class="chip" data-cat="${c.id}" aria-pressed="${c.id===activeCat}">${c.label}</button>`).join('');
    }
    chips.addEventListener('click', (e)=>{ const b=e.target.closest('[data-cat]'); if(!b) return; activeCat=b.dataset.cat; render(); renderChips(); });
    searchInput.addEventListener('input', render);
    sortSel.addEventListener('change', render);

    function setMode(newMode){
      mode=newMode; document.body.setAttribute('data-mode', mode);
      modeTabs.querySelectorAll('button').forEach(btn=>btn.setAttribute('aria-pressed', (btn.dataset.mode||btn.textContent.toLowerCase())===mode ? 'true':'false'));
      render();
    }
    modeTabs.addEventListener('click', (e)=>{ const b=e.target.closest('button'); if(!b) return; const m=b.dataset.mode||b.textContent.toLowerCase(); setMode(m); });

    // Product gallery per card
    const SLIDE_MS=3000;
    function renderGalleryHTML(imgs,pid,name,tag,rating){
      const fallback=ADMIN_BASE + 'placeholder.jpg';
      const slides=imgs.map((src,i)=>`
        <div class="gslide ${i===0?'active':''}">
          <img src="${src||fallback}" alt="${name} image ${i+1}" loading="${i===0?'eager':'lazy'}"
               onerror="this.onerror=null;this.src='${fallback}'">
        </div>`).join('');
      const dots=imgs.map((_,i)=>`<span class="dot ${i===0?'active':''}" data-i="${i}"></span>`).join('');
      const thumbs=imgs.map((src,i)=>`<button class="gthumb ${i===0?'active':''}" data-i="${i}" aria-label="Show image ${i+1}">
        <img src="${src||fallback}" alt=""></button>`).join('');
      return `
        <div style="position:relative">
          ${tag?`<span class="tag">${tag}</span>`:''}
          <span class="rating">${(rating||4.5).toFixed(1)} ★</span>
          <div class="gallery" data-pid="${pid}">
            <div class="gallery-main">
              ${slides}
              <div class="garrows"><button class="gprev" aria-label="Previous image">‹</button><button class="gnext" aria-label="Next image">›</button></div>
              <div class="gdots">${dots}</div>
            </div>
            <div class="gthumbs">${thumbs}</div>
          </div>
        </div>`;
    }

    function initAllGalleries(){
      document.querySelectorAll('.gallery').forEach(gal=>{
        const slides=[...gal.querySelectorAll('.gslide')];
        const dots=[...gal.querySelectorAll('.gdots .dot')];
        const thumbs=[...gal.querySelectorAll('.gthumb')];
        const prevBtn=gal.querySelector('.gprev');
        const nextBtn=gal.querySelector('.gnext');
        let i=0,timer=null;
        const show=n=>{
          i=(n+slides.length)%slides.length;
          slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
          dots.forEach((d,idx)=>d.classList.toggle('active',idx===i));
          thumbs.forEach((t,idx)=>t.classList.toggle('active',idx===i));
        };
        const start=()=>{ if(slides.length>1 && !timer) timer=setInterval(()=>show(i+1),SLIDE_MS); };
        const stop =()=>{ if(timer){clearInterval(timer);timer=null;} };
        prevBtn.addEventListener('click',()=>{stop();show(i-1);start();});
        nextBtn.addEventListener('click',()=>{stop();show(i+1);start();});
        thumbs.forEach(btn=>btn.addEventListener('click',()=>{stop();show(+btn.dataset.i||0);start();}));
        gal.addEventListener('mouseenter',stop);
        gal.addEventListener('mouseleave',start);
        // touch swipe
        let sx=0,sy=0,dx=0,dy=0,touching=false;
        gal.addEventListener('touchstart',e=>{ if(!e.touches[0])return; touching=true;sx=e.touches[0].clientX;sy=e.touches[0].clientY;dx=dy=0;stop(); },{passive:true});
        gal.addEventListener('touchmove',e=>{ if(!touching||!e.touches[0])return; dx=e.touches[0].clientX-sx; dy=e.touches[0].clientY-sy; },{passive:true});
        gal.addEventListener('touchend',()=>{ if(!touching)return; touching=false; if(Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy)){ dx<0?show(i+1):show(i-1);} start(); });
        if(slides.length<=1){ prevBtn.style.display='none'; nextBtn.style.display='none'; gal.querySelector('.gdots').style.display='none'; gal.querySelector('.gthumbs').style.display='none'; }
        show(0); start();
      });
    }

    function render(){
      const q=(searchInput.value||'').trim().toLowerCase();
      let items=PRODUCTS.filter(p=>(activeCat==='all'||p.category===activeCat) && (!q || (p.name+' '+(p.desc||'')).toLowerCase().includes(q)));
      const sort=sortSel.value;
      if(sort==='priceAsc') items.sort((a,b)=>priceOf(a)-priceOf(b));
      if(sort==='priceDesc') items.sort((a,b)=>priceOf(b)-priceOf(a));
      if(sort==='name') items.sort((a,b)=>a.name.localeCompare(b.name));
      if(sort==='pop') items.sort((a,b)=>(b.tag?1:0)-(a.tag?1:0));

      grid.innerHTML=items.map(p=>{
        const pr=priceOf(p);
        const imgs=normalizeImgs(p);
        return `<div class="card">
          ${renderGalleryHTML(imgs,p.id,p.name,p.tag,p.rating)}
          <div class="body">
            <h3>${p.name} ${mode==='wholesale'?`<span class="moq">MOQ ${minQty(p)}</span>`:''}</h3>
            <p class="muted" style="min-height:34px">${p.desc||''}</p>
            <div class="price">${fmtUGX(pr)} ${mode==='retail'?'(Retail)':'(Wholesale)'} ${mode==='wholesale'?`<span class="moq">MOQ ${minQty(p)}</span>`:''}</div>
            <div class="qty">
              <label>Qty: <input type="number" id="qty-${p.id}" value="${minQty(p)}" min="${minQty(p)}" step="${minQty(p)}" aria-label="Quantity for ${p.name}"></label>
              <span class="muted">/ ${p.unit||'piece'}</span>
            </div>
            <div class="stack">
              <button class="button" onclick="addToCart('${p.id}')">Add to Cart</button>
              <button class="button buyNow" onclick="buyNow('${p.id}')">Buy Now (COD)</button>
            </div>
          </div>
        </div>`;
      }).join('');
      initAllGalleries();
    }

    // ===== Cart & Checkout =====
    function addToCart(id){
      const p=PRODUCTS.find(x=>x.id===id); if(!p) return;
      const qtyInput=document.getElementById(`qty-${id}`);
      let qty=parseInt(qtyInput?.value)||minQty(p); if(qty<minQty(p)) qty=minQty(p);
      const key=id+':'+mode; const unitPrice=priceOf(p); const existing=cart.get(key);
      cart.set(key,{product:p,qty:(existing?existing.qty:0)+qty,unitPrice,mode}); updateCartUI(); openDrawer();
    }
    function buyNow(id){
      const p=PRODUCTS.find(x=>x.id===id); if(!p) return;
      const q=parseInt(document.getElementById(`qty-${id}`)?.value)||minQty(p);
      const qty=q<minQty(p)?minQty(p):q; const unitPrice=priceOf(p);
      const msg=`Hi Orji Supplies, I want to order (Cash on Delivery):\n• ${p.name} x${qty} @ ${fmtUGX(unitPrice)} (${mode})`;
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`,'_blank');
    }
    function updateCartUI(){
      cartLines.innerHTML=''; let subtotal=0,count=0;
      cart.forEach(({product,qty,unitPrice,mode})=>{
        const line=unitPrice*qty; subtotal+=line; count+=qty;
        const row=document.createElement('div'); row.style.borderBottom='1px dashed var(--line)'; row.style.padding='8px 0';
        row.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <div><strong>${product.name}</strong><br><span class="muted">${mode==='retail'?'Retail':'Wholesale'} • ${fmtUGX(unitPrice)} × ${qty}</span></div>
          <div><strong>${fmtUGX(line)}</strong><br><button class="button" style="padding:6px 8px;font-size:12px" onclick="removeLine('${product.id}','${mode}')">Remove</button></div>
        </div>`;
        cartLines.appendChild(row);
      });
      const fee=estDeliveryFee(areaSel.value,subtotal);
      grandTotal.textContent='Total: '+fmtUGX(subtotal+fee)+(fee?` (incl. est delivery ${fmtUGX(fee)})`:' (Free delivery)');
      cartCount.style.display = count>0?'inline-block':'none'; cartCount.textContent=count;
      checkoutFab.href = cartToWhatsApp(subtotal,fee);
      updateFabVisibility();
    }
    function removeLine(id,m){ cart.delete(id+':'+m); updateCartUI(); }
    function cartToWhatsApp(subtotal=0,fee=0){
      if(cart.size===0) return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent('Hi Orji Supplies')}`;
      const lines=[]; cart.forEach(({product,qty,unitPrice,mode})=>lines.push(`• ${product.name} x${qty} @ ${fmtUGX(unitPrice)} (${mode})`));
      const msg=`Hello Orji Supplies, here is my order (Cash on Delivery):\n${lines.join('\n')}\nSubtotal: ${fmtUGX(subtotal)}\nEst. Delivery: ${fmtUGX(fee)}\nTotal (est): ${fmtUGX(subtotal+fee)}`;
      return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
    }
    function updateFabVisibility(){ const visible=cart.size>0 && drawer.classList.contains('open'); checkoutFab.style.display = visible ? 'flex':'none'; }
    function openDrawer(){ drawer.classList.add('open'); updateFabVisibility(); }
    closeDrawer.onclick=()=>{ drawer.classList.remove('open'); updateFabVisibility(); };
    cartBtn.onclick=()=>{ drawer.classList.toggle('open'); updateFabVisibility(); };

    // Checkout
    openCheckout.addEventListener('click', ()=>{
      if(cart.size===0){ alert('Your cart is empty. Please add items first.'); return; }
      custArea.value = areaSel.value;
      checkoutModal.classList.add('open');
    });
    closeModal.addEventListener('click', ()=> checkoutModal.classList.remove('open'));
    checkoutModal.addEventListener('click', (e)=>{ if(e.target===checkoutModal) checkoutModal.classList.remove('open'); });
    placeOrderBtn.addEventListener('click', (e)=>{
      const name=(custName.value||'').trim(), phone=(custPhone.value||'').trim();
      if(!name||!phone){ alert('Please enter your name and phone.'); e.preventDefault(); return; }
      let subtotal=0, lines=[]; cart.forEach(({product,qty,unitPrice,mode})=>{ subtotal+=unitPrice*qty; lines.push(`• ${product.name} x${qty} @ ${fmtUGX(unitPrice)} (${mode})`); });
      const fee=estDeliveryFee(custArea.value,subtotal);
      const text=`Order Request – CASH ON DELIVERY\n\nCustomer: ${name}\nPhone: ${phone}\nArea: ${custArea.value}\nTime: ${custTime.value}\nAddress: ${custAddr.value||'-'}\nNote: ${custNote.value||'-'}\n\nItems:\n${lines.join('\n')}\nSubtotal: ${fmtUGX(subtotal)}\nEst. Delivery: ${fmtUGX(fee)}\nTotal (est): ${fmtUGX(subtotal+fee)}\n\nPlease confirm availability & delivery time.`;
      placeOrderBtn.href=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
    });

    // ========= Fetch products =========
    async function loadProducts(){
      try{
        const res = await fetch(PRODUCTS_URL, { cache:'no-store' });
        if(!res.ok) throw new Error(`Failed to load products.json (${res.status})`);
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('products.json must be an array');

        PRODUCTS = data.map(p=>{
          const copy = {...p};
          if(Array.isArray(copy.imgs)) copy.imgs = copy.imgs.map(absFromAdmin);
          if(copy.img) copy.img = absFromAdmin(copy.img);
          return copy;
        });

        renderChips(); render();
      }catch(err){
        grid.innerHTML = `
          <div style="grid-column:1/-1;background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px">
            <strong>Couldn’t load catalog.</strong>
            <div class="muted" style="margin-top:6px">
              Make sure <code>products.json</code> is published at
              <a href="${PRODUCTS_URL}" target="_blank">${PRODUCTS_URL}</a>.
            </div>
            <div class="muted" style="margin-top:8px">Error: ${err.message}</div>
          </div>`;
        renderChips();
      }
    }

    // Init
    loadHero();
    loadProducts();
  </script>
</body>
</html>
