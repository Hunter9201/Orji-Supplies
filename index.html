<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Orji Supplies — Admin (Upload to GitHub)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#0ea5e9;--ok:#16a34a;--bad:#ef4444;--card:#fff;--bg:#f8fafc}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:2fr 3fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .card .body{padding:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-weight:700;font-size:14px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
  .muted{color:var(--muted)}
  .button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:700;cursor:pointer}
  .primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .images{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  .images .preview{position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#f8fafc}
  .images img{width:100%;height:160px;object-fit:cover;display:block;background:#f1f5f9}
  .images .rm{position:absolute;top:6px;right:6px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tag{display:inline-block;background:#0ea5e90f;border:1px solid #bae6fd;color:#0369a1;font-weight:800;padding:3px 8px;border-radius:999px}
  .small{font-size:12px}
  .list{display:grid;gap:8px}
  .list .item{border:1px dashed var(--line);border-radius:10px;padding:10px}
  .code{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px solid var(--line);padding:10px;border-radius:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <strong>Orji Supplies — Admin</strong>
    <div class="bar">
      <button id="setTokenBtn" class="button">Set GitHub Token</button>
      <button id="clearTokenBtn" class="button bad">Clear Token</button>
      <span id="tokenState" class="tag">No token</span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Left: Form -->
    <div class="card">
      <div class="body">
        <h2 style="margin:0 0 10px">New Product</h2>
        <div class="row">
          <div>
            <label>Product Name</label>
            <input id="pName" placeholder="e.g., Harpic Power Plus 10X">
          </div>
          <div>
            <label>Category</label>
            <select id="pCat">
              <option value="laundry">Laundry</option>
              <option value="home">Home</option>
              <option value="accessories">Accessories</option>
              <option value="pest">Pest Control</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Retail Price (UGX)</label>
            <input id="pRetail" type="number" placeholder="16000">
          </div>
          <div>
            <label>Wholesale Price (UGX)</label>
            <input id="pWholesale" type="number" placeholder="14000">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Unit</label>
            <input id="pUnit" placeholder="bottle / bag / pack">
          </div>
          <div>
            <label>MOQ (wholesale)</label>
            <input id="pMoq" type="number" placeholder="12" value="1">
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Description</label>
          <textarea id="pDesc" rows="3" placeholder="Short description..."></textarea>
        </div>
        <div style="margin-top:12px">
          <label>Images (up to 4)</label>
          <div class="bar" style="margin:6px 0">
            <input id="fileInput" type="file" accept="image/*" multiple>
            <button class="button" onclick="document.getElementById('fileInput').click()">Choose Files</button>
            <span class="muted small">Files will be uploaded to your repo’s <code>/images/</code> folder.</span>
          </div>
          <div id="imgGrid" class="images"></div>
        </div>
        <div class="bar" style="margin-top:14px">
          <button id="publishBtn" class="button primary">Publish to GitHub</button>
          <button id="resetBtn" class="button">Reset Form</button>
        </div>
        <div id="status" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- Right: Manage + preview + log -->
    <div class="card">
      <div class="body">
        <h3 style="margin:0 0 10px">Manage Products (GitHub)</h3>
        <div class="bar" style="margin-bottom:8px">
          <button id="refreshBtn" class="button">Refresh List</button>
          <label class="small" title="If checked, deleting a product will also remove its images from /images/">
            <input type="checkbox" id="delImagesToggle"> also delete images
          </label>
        </div>
        <div id="prodList" class="list"></div>

        <h3 style="margin:16px 0 10px">Last Published Product (local preview)</h3>
        <div id="preview" class="list"></div>

        <h4 style="margin:14px 0 6px">Debug Log</h4>
        <div id="log" class="code"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ======== EDIT THESE 5 LINES TO MATCH YOUR REPO ======== */
const GH_OWNER = "hunter9201";
const GH_REPO = "Orji-Supplies";
const GH_BRANCH = "main";
const GH_IMAGES_DIR = "images";          // folder in repo
const GH_PRODUCTS_PATH = "products.json"; // file in repo root (or "data/products.json")
/* ======================================================= */

// Token storage key
const TOKEN_KEY = "ORJI_GH_TOKEN_V1";

// UI refs
const tokenState = document.getElementById('tokenState');
const setTokenBtn = document.getElementById('setTokenBtn');
const clearTokenBtn = document.getElementById('clearTokenBtn');
const fileInput = document.getElementById('fileInput');
const imgGrid = document.getElementById('imgGrid');
const publishBtn = document.getElementById('publishBtn');
const resetBtn = document.getElementById('resetBtn');
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const previewEl = document.getElementById('preview');

const refreshBtn = document.getElementById('refreshBtn');
const prodList = document.getElementById('prodList');
const delImagesToggle = document.getElementById('delImagesToggle');

// Form refs
const pName = document.getElementById('pName');
const pCat = document.getElementById('pCat');
const pRetail = document.getElementById('pRetail');
const pWholesale = document.getElementById('pWholesale');
const pUnit = document.getElementById('pUnit');
const pMoq = document.getElementById('pMoq');
const pDesc = document.getElementById('pDesc');

let files = []; // selected images

function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }
function setStatus(msg){ statusEl.textContent = msg; }
function token(){ return localStorage.getItem(TOKEN_KEY) || ""; }
function tokenOk(){ const t = token(); tokenState.textContent = t ? "Token set" : "No token"; tokenState.style.background = t ? "#dcfce7" : "#0ea5e90f"; }
setTokenBtn.onclick = ()=>{ const t = prompt("Paste your GitHub Personal Access Token (fine-grained, contents: read/write):"); if (t) localStorage.setItem(TOKEN_KEY,t.trim()); tokenOk(); };
clearTokenBtn.onclick = ()=>{ localStorage.removeItem(TOKEN_KEY); tokenOk(); };

// file selection
fileInput.addEventListener('change', (e)=>{
  files = Array.from(e.target.files||[]).slice(0,4);
  renderFiles();
});
function renderFiles(){
  imgGrid.innerHTML = files.map((f,i)=>`
    <div class="preview">
      <img src="${URL.createObjectURL(f)}" alt="">
      <button class="button bad rm small" onclick="removeFile(${i})">x</button>
    </div>
  `).join('') || '<span class="muted small">No files selected.</span>';
}
window.removeFile = (i)=>{ files.splice(i,1); renderFiles(); };

// GitHub helpers
const API_BASE = "https://api.github.com";
function ghHeaders(){ return { "Authorization":"Bearer "+token(), "Accept":"application/vnd.github+json" }; }

async function ghGetContents(path){
  const url = `${API_BASE}/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(GH_BRANCH)}`;
  const r = await fetch(url, {headers: ghHeaders()});
  if (r.status === 404) return {status:404};
  if (!r.ok) throw new Error(`GET ${path} failed: ${r.status} ${await r.text()}`);
  return await r.json(); // includes .sha, .content (base64) for files
}

async function ghPutContents(path, base64Content, message, sha=null){
  const url = `${API_BASE}/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: base64Content, branch: GH_BRANCH };
  if (sha) body.sha = sha;
  const r = await fetch(url, {
    method: "PUT",
    headers: {...ghHeaders(), "Content-Type":"application/json"},
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(`PUT ${path} failed: ${r.status} ${await r.text()}`);
  return await r.json();
}

// NEW: delete a file at path (needs current file SHA)
async function ghDeleteContents(path, message, sha){
  const url = `${API_BASE}/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, {
    method: "DELETE",
    headers: {...ghHeaders(), "Content-Type":"application/json"},
    body: JSON.stringify({ message, sha, branch: GH_BRANCH })
  });
  if (!r.ok) throw new Error(`DELETE ${path} failed: ${r.status} ${await r.text()}`);
  return await r.json();
}

function toBase64Utf8(str){
  return btoa(unescape(encodeURIComponent(str)));
}
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>{
      const arr = new Uint8Array(fr.result);
      let bin = "";
      for (let i=0;i<arr.length;i++) bin += String.fromCharCode(arr[i]);
      res(btoa(bin));
    };
    fr.onerror = ()=>rej(fr.error);
    fr.readAsArrayBuffer(file);
  });
}

function slugify(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,50) || "item"; }

// ===== PUBLISH flow (unchanged) =====
publishBtn.onclick = async ()=>{
  try{
    if (!token()){ alert("Set your GitHub token first."); return; }
    const name = pName.value.trim();
    if (!name){ alert("Enter product name."); return; }
    if (!pRetail.value){ alert("Enter retail price."); return; }

    setStatus("Uploading images...");
    log("== Start publish ==");
    const ts = Date.now();
    const baseSlug = `${slugify(name)}-${ts}`;
    const rawUrls = [];

    for (let i=0;i<files.length;i++){
      const f = files[i];
      const ext = (f.name.split('.').pop()||'bin').toLowerCase().replace(/[^a-z0-9]/g,'') || "bin";
      const fname = `${baseSlug}-${i+1}.${ext}`;
      const path = `${GH_IMAGES_DIR}/${fname}`;
      const b64 = await fileToBase64(f);
      await ghPutContents(path, b64, `Upload image ${fname}`);
      const url = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${encodeURIComponent(GH_IMAGES_DIR)}/${encodeURIComponent(fname)}`;
      rawUrls.push(url);
      log(`Uploaded ${path}`);
    }
    if (rawUrls.length === 0){ log("No images selected; continuing."); }

    setStatus("Updating products.json...");
    let arr = [];
    let sha = null;
    const got = await ghGetContents(GH_PRODUCTS_PATH);
    if (got.status !== 404){
      sha = got.sha;
      const content = atob(got.content.replace(/\n/g,''));
      const text = decodeURIComponent(escape(content));
      try{ arr = JSON.parse(text); if (!Array.isArray(arr)) arr = []; } catch(e){ arr = []; }
      log("Loaded existing products.json");
    } else {
      log("products.json does not exist; will create.");
    }

    const product = {
      id: baseSlug,
      name,
      category: pCat.value,
      retailPrice: Number(pRetail.value)||0,
      wholesalePrice: Number(pWholesale.value)||0,
      unit: pUnit.value.trim()||"piece",
      moq: Number(pMoq.value)||1,
      desc: pDesc.value.trim(),
      imgs: rawUrls
    };
    arr.push(product);

    const jsonStr = JSON.stringify(arr, null, 2);
    const b64 = toBase64Utf8(jsonStr);
    await ghPutContents(GH_PRODUCTS_PATH, b64, `Add product ${product.id}`, sha||undefined);
    log("products.json updated.");

    setStatus("Done! Product published to GitHub.");
    previewEl.innerHTML = `
      <div class="item">
        <div><strong>${product.name}</strong> — UGX ${product.retailPrice.toLocaleString('en-UG')}</div>
        <div class="muted small">${product.desc||''}</div>
        <div class="muted small">Images: ${product.imgs.length}</div>
      </div>`;
    alert("Published! Open your shop (index.html). If it’s already open, refresh it.");
    // Refresh product list after publish
    await refreshProductsList();
  }catch(err){
    console.error(err);
    log(String(err));
    setStatus("Error: " + err.message);
    alert("Publish failed:\n" + err.message);
  }
};

resetBtn.onclick = ()=>{
  pName.value = ""; pRetail.value=""; pWholesale.value=""; pUnit.value=""; pMoq.value="1"; pDesc.value="";
  files = []; renderFiles(); setStatus("");
};

// ===== MANAGE (Delete) =====
function filenameFromRawUrl(u){
  try{
    const url = new URL(u);
    const name = url.pathname.split('/').pop() || "";
    return decodeURIComponent(name);
  }catch{ return ""; }
}

function renderProductsAdmin(arr){
  if (!Array.isArray(arr) || !arr.length){
    prodList.innerHTML = '<div class="muted small">No products found in products.json.</div>';
    return;
  }
  prodList.innerHTML = arr.map(p=>`
    <div class="item" data-id="${p.id}">
      <div class="bar" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div><strong>${p.name}</strong> <span class="muted small">(${p.id})</span></div>
          <div class="muted small">Cat: ${p.category||'-'} • Retail: UGX ${(p.retailPrice||0).toLocaleString('en-UG')} • Images: ${(p.imgs||[]).length}</div>
          <div class="muted small">${p.desc ? p.desc.slice(0,120) : ''}</div>
        </div>
        <div class="bar">
          <button class="button bad" data-action="delete" data-id="${p.id}">Delete</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function loadProductsJson(){
  const got = await ghGetContents(GH_PRODUCTS_PATH);
  if (got.status === 404) return { arr: [], sha: null };
  const sha = got.sha;
  const content = atob(got.content.replace(/\n/g,''));
  const text = decodeURIComponent(escape(content));
  let arr = [];
  try{ arr = JSON.parse(text); if (!Array.isArray(arr)) arr = []; } catch(e){ arr = []; }
  return { arr, sha };
}

async function refreshProductsList(){
  try{
    setStatus("Loading products from GitHub…");
    const { arr } = await loadProductsJson();
    renderProductsAdmin(arr);
    setStatus("Ready.");
  }catch(err){
    log("Load list error: " + err.message);
    setStatus("Error loading list.");
  }
}

async function deleteProduct(productId, alsoDeleteImages){
  if (!token()){ alert("Set your GitHub token first."); return; }
  if (!confirm(`Delete product "${productId}"${alsoDeleteImages ? " and its images" : ""}? This cannot be undone.`)) return;

  setStatus("Deleting…");
  log(`== Delete ${productId} ==`);
  const { arr, sha } = await loadProductsJson();
  const idx = arr.findIndex(p => p.id === productId);
  if (idx === -1){ alert("Product not found."); return; }
  const product = arr[idx];

  // Optionally delete images
  if (alsoDeleteImages && Array.isArray(product.imgs)){
    for (const u of product.imgs){
      const fname = filenameFromRawUrl(u);
      if (!fname) { log(`Skip image (no filename): ${u}`); continue; }
      const path = `${GH_IMAGES_DIR}/${fname}`;
      try{
        const got = await ghGetContents(path);
        if (got.status === 404){ log(`Image not found in repo: ${path}`); continue; }
        await ghDeleteContents(path, `Delete image ${fname} (product ${productId})`, got.sha);
        log(`Deleted image: ${path}`);
      }catch(e){
        log(`Failed to delete image ${path}: ${e.message}`);
      }
    }
  }

  // Remove product from array and write back
  const newArr = arr.filter(p => p.id !== productId);
  const jsonStr = JSON.stringify(newArr, null, 2);
  const b64 = toBase64Utf8(jsonStr);
  await ghPutContents(GH_PRODUCTS_PATH, b64, `Delete product ${productId}`, sha||undefined);
  log(`Removed ${productId} from products.json`);
  setStatus("Deleted.");

  await refreshProductsList();
}

// Wire up UI
refreshBtn.addEventListener('click', refreshProductsList);
prodList.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action="delete"]');
  if (!btn) return;
  const id = btn.dataset.id;
  const also = !!delImagesToggle.checked;
  try{
    await deleteProduct(id, also);
  }catch(err){
    log("Delete error: " + err.message);
    alert("Delete failed:\n" + err.message);
  }
});

tokenOk();
renderFiles();
refreshProductsList(); // load list on open
</script>
</body>
</html>
